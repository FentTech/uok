# Supabase Setup Guide - Bond Syncing & Real-Time Notifications

This guide explains how to set up the required Supabase tables for the new Bond Syncing and Real-Time Notifications features.

## Required Tables

You need to create the following table in your Supabase database:

### 1. bond_relationships Table

This table stores the directional bond relationships between users (who bonded with whom).

```sql
-- Create bond_relationships table
CREATE TABLE IF NOT EXISTS bond_relationships (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  bonding_user_name VARCHAR(255) NOT NULL,
  bonding_user_email VARCHAR(255) NOT NULL,
  contact_name VARCHAR(255) NOT NULL,
  contact_email VARCHAR(255),
  bond_code VARCHAR(50) NOT NULL UNIQUE,
  status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'pending')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Create indexes for faster queries
CREATE INDEX idx_bonding_user_email ON bond_relationships(bonding_user_email);
CREATE INDEX idx_contact_name ON bond_relationships(contact_name);
CREATE INDEX idx_bond_code ON bond_relationships(bond_code);
CREATE INDEX idx_status ON bond_relationships(status);
```

## Existing Tables (Already Configured)

The following tables should already exist in your Supabase setup:

- **check_ins**: Stores individual check-in records
- **notifications**: Stores notifications for bonded contacts
- **bonded_contacts**: Stores user's bonded contacts list
- **user_profiles**: Stores user profile information
- **user_check_ins**: Stores aggregated user check-ins

## How Bond Syncing Works

### 1. User Creates Bonds (SetupContacts.tsx)
- User adds emergency contacts locally
- Bonds are saved to `bond_relationships` table via `supabaseBondService.createBond()`
- Each bond is directional: User A → Contact B

### 2. User Logs In on Another Device (Dashboard.tsx)
- App loads bonds from Supabase via `supabaseBondService.getUserBonds(userEmail)`
- App also loads "incoming bonds" via `supabaseBondService.getIncomingBonds(userName)`
- Incoming bonds are people who have bonded with this user

### 3. User Checks In (Dashboard.tsx handleCheckIn)
- Check-in is stored locally and in Supabase
- Notification is sent to each bonded contact via:
  - Local storage (for same-device access)
  - Supabase notifications table (for cross-device access)

### 4. Real-Time Notifications (Dashboard.tsx)
- App subscribes to notifications via `supabaseBondService.subscribeToNotifications()`
- When a check-in notification arrives, it's immediately displayed
- Browser notification is shown if permission granted

## Setting Up in Supabase Dashboard

1. Go to your Supabase project: https://supabase.com
2. Open the SQL Editor
3. Create a new query
4. Copy and paste the SQL above
5. Run the query
6. Verify the table is created in the "Tables" view

## Features Enabled by This Setup

✅ **Multi-Device Bond Synchronization**: Bonds created on Device 1 appear on Device 2  
✅ **Cross-Device Notifications**: Check-ins from Device 1 trigger alerts on Device 2  
✅ **Real-Time Updates**: New check-ins appear instantly via Supabase Realtime  
✅ **Incoming Bonds**: Users can see check-ins from people who bonded with them  

## Testing the Implementation

### Test Scenario 1: Same Device, Different Login
1. Sign up as User A, add Mom as emergency contact
2. Switch user, sign up as User B with username "Mom"
3. Sign back in as User A
4. Verify Mom appears in bonded contacts
5. Check in - verify notification stored for Mom

### Test Scenario 2: Different Devices
1. Open UOK in Browser 1, sign in as User A
2. Add "Brother" as emergency contact
3. Open UOK in Browser 2 (incognito)
4. Sign in as User A
5. Verify "Brother" appears in bonded contacts on Browser 2
6. Check in on Browser 1 - should appear on Browser 2

### Test Scenario 3: Real-Time Notifications
1. Have Device 1 (User A) and Device 2 (User B / Mom)
2. Sign in as User A on Device 1, bond with Mom
3. Sign in as Mom on Device 2
4. Use check in on Device 1
5. Should see real-time notification on Device 2 in the notifications dropdown

## Troubleshooting

**Q: Bonds don't appear on second device**
A: Check that `.getUserBonds()` is being called with the correct email. Verify the email matches what was used during signup.

**Q: Notifications not appearing**
A: 
- Check browser console for errors
- Verify contact has an email address (for Supabase notifications)
- Ensure Supabase credentials are correctly set in `.env`

**Q: Realtime not working**
A:
- Verify Supabase Realtime is enabled in your project settings
- Check that the notifications table exists
- Look for errors in browser DevTools Network tab

## Environment Variables Required

Make sure your `.env` file contains:
```
VITE_SUPABASE_URL=your_supabase_url
VITE_SUPABASE_ANON_KEY=your_supabase_anon_key
```

## Next Steps

1. Run the SQL migration in Supabase
2. Test the setup following the scenarios above
3. Verify real-time notifications work in your browser
4. Deploy to production
